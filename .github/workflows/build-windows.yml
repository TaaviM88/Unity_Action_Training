name: Build (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main" ]

# Needed so the workflow can create a GitHub Release
permissions:
  contents: write

jobs:
  build-windows:
    name: Windows Standalone Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: "Action Test/Library"
          key: Library-${{ runner.os }}-${{ hashFiles('Action Test/Assets/**', 'Action Test/Packages/**', 'Action Test/ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-

      - name: Build
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: "Action Test"
          unityVersion: auto
          targetPlatform: StandaloneWindows64
          buildName: CI-Windows
          buildsPath: build

      # Always upload artifact to the Actions run (handy even for branch builds)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WindowsBuild
          path: build/StandaloneWindows64

      # Only on tag builds (v*): zip the build folder
      - name: Zip Windows build
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cd build/StandaloneWindows64
          zip -r ../../WindowsBuild-${{ github.ref_name }}.zip .
          cd ../..

      # Only on tag builds (v*): create GitHub Release and upload the zip
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: WindowsBuild-${{ github.ref_name }}.zip
          generate_release_notes: true
