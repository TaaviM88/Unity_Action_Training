name: Build (Windows)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-windows:
    name: Windows Standalone Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed to generate changelogs between tags

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: "Action Test/Library"
          key: Library-${{ runner.os }}-${{ hashFiles('Action Test/Assets/**', 'Action Test/Packages/**', 'Action Test/ProjectSettings/**') }}
          restore-keys: |
            Library-${{ runner.os }}-

      - name: Build
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: "Action Test"
          unityVersion: auto
          targetPlatform: StandaloneWindows64
          buildName: CI-Windows
          buildsPath: build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WindowsBuild
          path: build/StandaloneWindows64

      - name: Zip Windows build
        run: |
          cd build/StandaloneWindows64
          zip -r ../../WindowsBuild.zip .
          cd ../..

      # -----------------------------
      # 1) TAGGED RELEASES (v*)
      # -----------------------------

      - name: Create changelog for this tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Find previous tag (if any) and generate a simple changelog
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | grep -v "^${GITHUB_REF_NAME}$" | head -n 1 || true)
          echo "Previous tag: $PREV_TAG"
          echo "## Changes" > RELEASE_BODY.md
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" "$PREV_TAG..${GITHUB_REF_NAME}" >> RELEASE_BODY.md
          else
            git log --pretty=format:"- %s (%h)" "${GITHUB_REF_NAME}" >> RELEASE_BODY.md
          fi
          echo "" >> RELEASE_BODY.md
          echo "## Build" >> RELEASE_BODY.md
          echo "- Unity: 6.3.1f1" >> RELEASE_BODY.md
          echo "- Target: StandaloneWindows64" >> RELEASE_BODY.md

      - name: Release (tagged)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: WindowsBuild.zip
          # GitHub auto-generates notes from commits/PRs. We'll ALSO add our own body.
          generate_release_notes: true
          body_path: RELEASE_BODY.md
          # If tag name contains "-rc" or "-beta" or "-alpha", mark as prerelease
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}

      # -----------------------------
      # 2) NIGHTLY PRERELEASE (no tags)
      # -----------------------------

      - name: Release (nightly on main)
        if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly (build ${{ github.run_number }})
          prerelease: true
          files: WindowsBuild.zip
          body: |
            Automated nightly build from main.

            - Run: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Unity: 6.3.1f1
            - Target: StandaloneWindows64
